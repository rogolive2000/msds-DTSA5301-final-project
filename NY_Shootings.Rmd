---
title: 'Peer-graded Assignment: NYPD Shooting Incident Data Report'
author: "Rogerio Oliveira"
date: "10-Sep-2021"
output:
  html_document:
    df_print: paged
  pdf_document: default
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(message = FALSE)
```
## 1 - Import Libraries
```{r libraries}

# Install libraries
# install.packages("gtools")
# install.packages("tidyverse")
# install.packages("lubridate")
# install.packages("kableExtra")

# Load libraries
library(gtools)
library(tidyverse)
library(lubridate)
library(kableExtra)
```
## 2 - Load Datasets

### 2.1 - NYPD Shooting Incidents
* Source: data extracted from NYC OpenData website at https://data.cityofnewyork.us

```{r nypd_shootings_dataLoad}
url_in = "https://data.cityofnewyork.us/api/views/833y-fsy8/rows.csv?accessType=DOWNLOAD"

ny_shootings = read_csv(url_in)

# Quick peek at the dataframe
head(ny_shootings) %>%
  kbl() %>% 
    kable_styling(bootstrap_options = c("striped", "condensed"), 
                  full_width = FALSE, position = "left", font_size = 12) %>%
  scroll_box(width = "100%")

# Dataframe structure
str(ny_shootings)
```

#### 2.1.1 - Date Formatting
* An initial view of the NYPD Shooting Incidents dataframe structure reveals that following steps will need to be carried out prior to the data cleanup step:

  + Convert OCCUR_DATE to date object
  
  + Convert OCCUR_TIME TO time object
  
```{r nypd_shootings_date_time}
# Format date and time
ny_shootings = ny_shootings %>% mutate(OCCUR_DATE = mdy(OCCUR_DATE))
ny_shootings = ny_shootings %>% mutate(OCCUR_TIME = hms(OCCUR_TIME))
```

### 2.2 - New York City Population
* Some of the analysis will be performed in relation to the NYC borough populations, therefore we will need to add a population dataset to the report.

* Source: data extracted from "Open NY" website at https://data.ny.gov/

```{r nyc_population_dataload}
url_in = "https://data.ny.gov/api/views/krt9-ym2k/rows.csv?accessType=DOWNLOAD&sorting=true"

ny_population = read_csv(url_in)

# Quick peek at the dataframe
# rbind(head(ny_population, 5), tail(ny_population, 5)) %>%
#  kbl() %>% 
#    kable_styling(bootstrap_options = c("striped", "condensed"), 
#                  full_width = FALSE, position = "left", font_size = 12) %>%
#  scroll_box(width = "100%")

# Dataframe structure
str(ny_population)
```

#### 2.2.1 - Filter Out non-NYC Counties
* The population dataset includes all counties of the NY state. We need to filter out non-NYC counties.

* In addition, we need to convert the resulting county names to borough names as used in the NYPD shooting dataset.

```{r nyc_population_county}
# Function to map NY county names to NYC borough names
ny_county_to_boro <- function(ny_county) {
    case_when(ny_county == 'Bronx County' ~ 'BRONX', 
              ny_county == 'Kings County' ~ 'BROOKLYN', 
              ny_county == 'New York County' ~ 'MANHATTAN', 
              ny_county == 'Queens County' ~ 'QUEENS', 
              ny_county == 'Richmond County' ~ 'STATEN ISLAND')
}

# Select subset of columns from the NY state population dataset and
#   filter by the counties that are part of NYC
ny_population = ny_population %>% select(c(Geography, Year, Population)) %>%
    filter(Geography %in% 
           c('New York County', 'Kings County', 'Bronx County', 'Richmond County', 'Queens County')) %>%
     setNames(c('BORO', 'YEAR', 'POPULATION'))   

# The population dataset lists the geographies by county
# We need to map them to NYC borough names
ny_population$BORO = ny_population$BORO %>% map(ny_county_to_boro)
```

#### 2.2.2 - Filter Out Years Not Covered by NYPD Shooting Dataset
* To ensure both datasets cover the same timeframe, we will limit the entries in population dataset to those present in the NYPD Shooting dataset.

```{r nyc_population_years}
# Extract years covered by NYPD shootings dataset
nypd_shootings_years = year(ny_shootings$OCCUR_DATE) %>% unique()

# Filter out years in the population dataset that are not covered by NYPD shooting dataset
ny_population = ny_population[ny_population$YEAR %in% nypd_shootings_years, ]

# Convert boro column from list to string
ny_population$BORO = as.character(ny_population$BORO)

# Quick peek at the resulting dataframe
rbind(head(ny_population, 5), tail(ny_population, 5)) %>%
  kbl() %>% 
    kable_styling(bootstrap_options = c("striped", "condensed"), 
                  full_width = FALSE, position = "left", font_size = 12) %>%
  scroll_box(width = "100%")
```

### 2.3 - 2019 NYC Poverty Rates 
* The 2019 NYC Poverty Rates will be used later in the analysis to try to find correlations between higher shooting rates and poverty rates.
<BR>

* Source: data extracted from the US Census website at https://www.census.gov
```{r nyc_povery_dataload}
# Dataset with poverty rates in NYC as of 2019
url_in = "https://www.census.gov/quickfacts/fact/csv/newyorkcitynewyork,bronxcountynewyork,kingscountynewyork,newyorkcountynewyork,queenscountynewyork,richmondcountynewyork/PST045219"

ny_poverty = read_csv(url_in)

# Parse and wrangle the data 
ny_poverty = ny_poverty %>% filter(Fact == 'Persons in poverty, percent') %>%
    select('Fact', 
           'Bronx County, New York', 
           'Kings County, New York', 
           'New York County, New York', 
           'Queens County, New York', 
           'Richmond County, New York') %>%
    setNames(c('Fact', 'BRONX', 'BROOKLYN', 'MANHATTAN', 'QUEENS', 'STATEN ISLAND')) 

# Transpose table and set column names
ny_poverty = stack(ny_poverty[, -1]) %>% setNames(c('2019_POVERTY_RATES', 'BORO'))

# Reorder columns
ny_poverty = ny_poverty[, c(2, 1)] 

# Quick peek at the dataframe
ny_poverty %>%
  kbl() %>% 
    kable_styling(bootstrap_options = c("striped", "condensed"), 
                  full_width = FALSE, position = "left", font_size = 12) 
```

## 3 - Bias Identification
* The dataset contains columns indicating the perpetrator race and the victim(s) race. In my opinion, these columns serve no purpose in advancing the analysis or in uncovering insights and can lead to conscious or unconscious bias. 
<BR>

* I have identified these columns as a potential **bias sources** and will therefore remove them from the dataframe.
```{r bias_ident}
# Remove race columns from dataframe
ny_shootings = ny_shootings %>% select(-c(PERP_RACE, VIC_RACE))
```

## 4 - Data Cleanup and Transformation

### 4.1 - Check for Columns with NA Values
* The first step in the data cleaning process will be dealing with NA values. Let's check for columns with NA values.
```{r check_na}
# Check for NAs
  apply(ny_shootings, 2, function(x) any(is.na(x))) %>% 
    kbl() %>% 
      kable_styling(bootstrap_options = c("striped", "condensed"),
                    full_width = FALSE, position = "left", font_size = 12)
```
* Several columns contain NA values and these values will be converted to "UNKNOWN" for better readability. 
<BR>

* JURISDICTION_CODE is a candidate for a factor, so the NA values will be changed to -1 and an "UNKNOWN" label will be assigned to it when the column is converted to factor later in the data cleaning step.
```{r clean_na}
# Replace NAs with "UNKNOWN"
ny_shootings$LOCATION_DESC = ny_shootings$LOCATION_DESC %>% 
  replace_na('UNKNOWN')
ny_shootings$PERP_AGE_GROUP = ny_shootings$PERP_AGE_GROUP %>% replace_na('UNKNOWN')
ny_shootings$PERP_SEX = ny_shootings$PERP_SEX %>% replace_na('UNKNOWN')

# JURISDICTION_CODE is a candidate for a factor, -1 will be assigned to NA values
ny_shootings$JURISDICTION_CODE = ny_shootings$JURISDICTION_CODE %>% replace_na(-1)

```

### 4.2 - Check for invalid values or misspellings
* The next step in the data cleaning process will consist of checking individual columns for invalid values or misspellings. One way to do it is to group values and count the occurrences. This will quickly show any potential values that need to be cleaned up.
<BR><BR>


#### 4.2.1 - BORO column
```{r BORO_check}
ny_shootings %>% group_by(BORO) %>% count() %>%
  kbl() %>% 
    kable_styling(bootstrap_options = c("striped", "condensed"), 
                  full_width = FALSE, position = "left", font_size = 12)
```
* There are no apparent invalid/misspelled values in the BORO column.
<BR><BR>

#### 4.2.2 - JURISDICTION_CODE column
```{r JURISDICTION_CODE_check}
ny_shootings %>% group_by(JURISDICTION_CODE) %>% count() %>%
  kbl() %>% 
    kable_styling(bootstrap_options = c("striped", "condensed"), 
                  full_width = FALSE, position = "left", font_size = 12)
```
* There are no apparent invalid/misspelled values in the JURISDICTION_CODE column.
<BR><BR>

#### 4.2.3 - LOCATION_DESC column
```{r LOCATION_DESC_check}
ny_shootings %>% group_by(LOCATION_DESC) %>% count() %>%
  kbl() %>% 
    kable_styling(bootstrap_options = c("striped", "condensed"), 
                  full_width = FALSE, position = "left", font_size = 12)
```
* There are no apparent invalid/misspelled values in the LOCATION_DESC column.
<BR><BR>

#### 4.2.4 - STATISTICAL_MURDER_FLAG column
```{r STATISTICAL_MURDER_FLAG_check}
ny_shootings %>% group_by(STATISTICAL_MURDER_FLAG) %>% count()%>%
  kbl() %>% 
    kable_styling(bootstrap_options = c("striped", "condensed"), 
                  full_width = FALSE, position = "left", font_size = 12)
```
* There are no apparent invalid/misspelled values in the STATISTICAL_MURDER_FLAG column.
<BR><BR>

#### 4.2.5 - PERP_AGE_GROUP column
```{r PERP_AGE_GROUP_check}
ny_shootings %>% group_by(PERP_AGE_GROUP) %>% count() %>%
  kbl() %>% 
    kable_styling(bootstrap_options = c("striped", "condensed"), 
                  full_width = FALSE, position = "left", font_size = 12)
```
* There are clearly some invalid/misspelled values in the PERP_AGE_GROUP column and will be fixed by converting the invalid values to "UNKNOWN":
```{r PERP_AGE_GROUP_fix}
# Convert invalid ages to "UNKNOWN"
ny_shootings$PERP_AGE_GROUP[ny_shootings$PERP_AGE_GROUP 
                            %in% c('1020', '224', '940')] = "UNKNOWN"
ny_shootings %>% group_by(PERP_AGE_GROUP) %>% count() %>%
  kbl() %>% 
    kable_styling(bootstrap_options = c("striped", "condensed"), 
                  full_width = FALSE, position = "left", font_size = 12)
```

#### 4.2.6 - PERP_SEX column
```{r PERP_SEX_check}
ny_shootings %>% group_by(PERP_SEX) %>% count() %>%
  kbl() %>% 
    kable_styling(bootstrap_options = c("striped", "condensed"), 
                  full_width = FALSE, position = "left", font_size = 12)
```
* There are values marked as "U" and others as "UNKNOWN" in the PERP_SEX column, so I will change the "U" values to "UNKNOWN" for consistency:
```{r PERP_SEX_fix}
# Convert "U" in PERP_SEX to "UNKNOWN"
ny_shootings$PERP_SEX[ny_shootings$PERP_SEX %in% c('U')] = "UNKNOWN"

ny_shootings %>% group_by(PERP_SEX) %>% count() %>%
  kbl() %>% 
    kable_styling(bootstrap_options = c("striped", "condensed"), 
                  full_width = FALSE, position = "left", font_size = 12)
```

#### 4.2.7 - VIC_AGE_GROUP column
```{r VIC_AGE_GROUP_check}
ny_shootings %>% group_by(VIC_AGE_GROUP) %>% count() %>%
  kbl() %>% 
    kable_styling(bootstrap_options = c("striped", "condensed"), 
                  full_width = FALSE, position = "left", font_size = 12)
```
* There are no apparent invalid/misspelled values in VIC_AGE_GROUP column.
<BR><BR>

#### 4.2.8 - VIC_SEX column
```{r VIC_SEX_check}
ny_shootings %>% group_by(VIC_SEX) %>% count() %>%
  kbl() %>% 
    kable_styling(bootstrap_options = c("striped", "condensed"), 
                  full_width = FALSE, position = "left", font_size = 12)
```
* There are values marked as "U" in the VIC_SEX column, so I will change the "U" values to "UNKNOWN" for consistency:
```{r VIC_SEX_fix}
# Convert "U" in VIC_SEX to "UNKNOWN"
ny_shootings$VIC_SEX[ny_shootings$VIC_SEX %in% c('U')] = "UNKNOWN"

ny_shootings %>% group_by(VIC_SEX) %>% count() %>%
  kbl() %>% 
    kable_styling(bootstrap_options = c("striped", "condensed"), 
                  full_width = FALSE, position = "left", font_size = 12)
```

### 4.3 - Drop Unused Columns
* Lat/Long or X,Y coordinates columns will not be used, therefore they will be dropped from the dataframe.
```{r drop_cols}
# Drop unused columns from dataframe
ny_shootings = ny_shootings %>% 
  select(-c(X_COORD_CD, Y_COORD_CD, Latitude, Longitude, Lon_Lat))
```
<BR>

### 4.4 - Convert Categorical Values to Factors
* As per column specification in the metadata documentation, JURISDICTION_CODE contains categorical values. We will represent it as factors for better readability.
```{r convert_factor}
ny_shootings$JURISDICTION_CODE = 
  factor(ny_shootings$JURISDICTION_CODE, 
         labels = c('UNKNOWN', 'PATROL', 'TRANSIT', 'HOUSING'))
```
<BR>

## 5 - Data Engineering/Transformation

### 5.1 - Add a Column to Represent Time of The Day 
* The dataframe contains the timestamp of the incidents. It will be interesting to aggregate the incidents in time periods in order to assess if there are more incidents during a particular time of the day.
<BR>

* For the purpose of this analysis, hours between 1AM and 6AM will be considered "NIGHT", between 7AM and 12PM will be "MORNING", between 1PM and 6PM will be "AFTERNOON" and between 7PM and 12AM will be "EVENING".

```{r r_time_day}
# Function to categorize time of the day as a function of the hour of the incident 
time_of_day <- function(time) {
    hr = hour(time)
    case_when(hr >= 0 & hr < 6 ~ 'NIGHT', 
        hr >= 6 & hr < 12 ~ 'MORNING', 
        hr >= 12 & hr < 18 ~ 'AFTERNOON', 
        TRUE ~ 'EVENING')
}

# Create new column
ny_shootings$OCCUR_TIMEDAY = time_of_day(ny_shootings$OCCUR_TIME)
```

### 5.2 - Add a Column to Represent the Number of Victims 
* The metadata documentation states that the incident key can be duplicated in the cases when there are multiple victims in a given incident. 
<BR>

* We can use this fact to create a column that represents the number of victims per incident, which could be useful for the analysis later.
<BR>

* It is also desirable to create a new dataframe to represent the unique incidents, i.e., combine all victims of the same incident into one single occurrence. This could help produce a more accurate analysis.

```{r add_num_vic}
# Create a new dataframe with number of victims per incident
ny_shootings_num_vic = ny_shootings %>% group_by(INCIDENT_KEY) %>% 
    count() %>%
    rename('NUM_VIC' = n)

# Add number of victims per incident to NY shootings dataframe 
ny_shootings = ny_shootings %>% left_join(ny_shootings_num_vic, by = c('INCIDENT_KEY'))

# New dataframe to represent unique incidents
ny_shootings_unique = ny_shootings[!duplicated(ny_shootings$INCIDENT_KEY), ] 

# Print rowcounts
data.frame(c(count(ny_shootings), count(ny_shootings_unique))) %>% 
  setNames(c('Total Incidents','Total Unique Incidents')) %>%
  kbl() %>% 
    kable_styling(bootstrap_options = c("striped", "condensed"), 
                  full_width = FALSE, position = "left", font_size = 12)
```
* As observed above, there are many incidents in which multiple victims were involved. Some of the analysis will be desirable to be performed on the dataframe of unique incidents otherwise it could skew the statistics.
<BR><BR>

## 6 - Data Visualization and Analysis

### 6.1 - Number of NYC Shootings By Year
* The first analysis will focus on answering the simple question, "is the number of shootings in NYC increasing over time?"

* Notice that the dataframe of unique incidents will be used for the analysis rather than the original dataframe otherwise incidents with multiple victims would be overcounted (please see 5.2 for details).

* In addition, the Y-axis scale in all charts will be logarithmic in order to have a better sense of the rate of change over time.

```{r shootings_year}
# Shootings per year
ny_shootings_unique %>% group_by(year(OCCUR_DATE)) %>% count() %>% 
    setNames(c('YEAR', 'NUM_INC')) %>%
    ggplot(aes(x = YEAR, y = NUM_INC, group = 1)) +
    geom_line(aes(color = 'NUM_INC')) +
    geom_point(aes(color = 'NUM_INC')) +
    scale_x_continuous(breaks = scales::pretty_breaks(n = 20)) +
    scale_y_log10(breaks = scales::pretty_breaks(n = 10)) +
    scale_colour_discrete(name = '', labels = c('Number of Incidents')) +
    theme(legend.position = "bottom", axis.text.x = element_text(angle = 90)) +
    labs(title = "Number of Shooting Incidents in NYC By Year", 
         x= 'Year', y = NULL)
```

* Interesting to notice that the number of shootings/year had been steadily declining over time but there was a significant starting in 2019. One could speculate that the reason might be explained by the COVID-19 lockdown effects, which led to higher unemployment and potentially more criminality.

* Let us zoom in to 2019 - 2020 and check if there's any correlation between higher shooting incidents and the COVID-19 lockdown due to the global pandemic.

```{r shootings_2019_2020}
# Shootings per year - zoomed in to 2019-2020
ny_shootings_unique %>% group_by(format(as.Date(OCCUR_DATE), "%Y-%m")) %>% count() %>% 
    setNames(c('YEAR', 'NUM_INC')) %>%
    filter(YEAR >= '2019-01' & YEAR <= '2020-12') %>%
    ggplot(aes(x = YEAR, y = NUM_INC, group = 1)) +
    geom_line(aes(color = 'NUM_INC')) +
    geom_point(aes(color = 'NUM_INC')) +
    scale_y_log10(breaks = scales::pretty_breaks(n = 10)) +
    scale_colour_discrete(name = '', labels = c('Number of Incidents')) +
    theme(legend.position = "bottom", axis.text.x = element_text(angle = 90)) +
    labs(title = "Number of Shooting Incidents in NYC - 2019 to 2020", x= 'Year', y = NULL)
```

* Indeed, after April 2020 when the general population really started to experience the effects of the COVID-19 lockdown and the consequent job losses, we can identify a clear spike in the number of shootings, which strongly suggests a correlation between the two events.

### 6.2 - Number of NYC Shootings Per Million Inhabitants - By Year and Borough

* Another interesting analysis would be to explore the number of shooting incidents by year and as a function of NYC boroughs population, i.e. is the change in shooting incidents proportional to the population growth rate?

* This data point could identify which NYC boroughs tend to experience relative more shootings incidents per capita, which in turn could be used as a proxy to determine boroughs with potential higher criminality.

```{r shootings_year_boro}
# Incidents per million/borough
ny_shootings_unique %>% mutate(YEAR = year(OCCUR_DATE)) %>% 
    group_by(YEAR, BORO) %>% count() %>%
    setNames(c('YEAR', 'BORO', 'NUM_INC')) %>%
    left_join(ny_population, by = c('YEAR', 'BORO')) %>% 
    mutate(NUM_INC_PER_1MM = round(1000000 * NUM_INC / POPULATION)) %>%
    ggplot(aes(x = YEAR, y = NUM_INC_PER_1MM, group = BORO, color = BORO)) +
    geom_line() + geom_point() +
    scale_x_continuous(breaks = scales::pretty_breaks(n = 20)) +
    scale_y_log10(breaks = scales::pretty_breaks(n = 10)) +
    scale_colour_discrete(name = 'NYC Borough') + 
    theme(legend.position = 'bottom', axis.text.x = element_text(angle = 90)) +
    guides(color = guide_legend(nrow = 2, byrow = TRUE)) +  
    labs(title = 'Number of Shooting Incidents in NYC Per Million Inhabitants by Borough', x= 'Year', y = NULL)

# Table - Poverty Rates
ny_poverty %>%
  kbl() %>% 
    kable_styling(bootstrap_options = c("striped", "condensed"), 
                  full_width = FALSE, position = "left", font_size = 12)

# Bar chart - Poverty Rates
ny_poverty %>% setNames(c('BORO', 'POVERTY_RATES')) %>% 
    mutate(POVERTY_RATES = 
             as.numeric(str_replace_all(POVERTY_RATES, '%', ''))) %>% 
    ggplot(aes(x = BORO, y = POVERTY_RATES, fill = BORO)) +
    geom_bar(stat = "identity", width= 0.8) +
    scale_fill_brewer(palette = "Pastel1", 
                      name = 'Fatality Outcome') +
    geom_text(aes(label = paste(POVERTY_RATES, '%')), 
              color = "white", size = 4, 
              vjust = 1.5) +
    labs(title = 'Poverty Rates in NYC Boroughs', x= NULL, y = NULL) +
    theme_minimal() + 
    theme(
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        panel.border = element_blank(),
        panel.grid = element_blank(),
        axis.ticks = element_blank(),
        axis.text.x = element_text(size = 8, face = 'bold', vjust = 10),
        axis.text.y = element_blank(),
        legend.position = 'none', 
    )
```

* As it can be observed in the graph, the boroughs of Bronx and Brooklyn have a higher number of shootings per million than all other boroughs. Interesting to observe that those two boroughs have the highest poverty rates as of 2019, which can suggest some correlation between shooting incidents and higher poverty rates.

* Another point to note is that all boroughs experienced a sharp increase in the number of shooting incidents per million during the COVID-19 lockdown, perhaps as a result of higher crime due to higher unemployment caused by the lockdown.

### 6.3 - Number of NYC Shootings By Jurisdiction

```{r shootings_year_jurisd}
# Incidents per jurisdiction
ny_shootings_unique %>% mutate(YEAR = year(OCCUR_DATE)) %>% 
    group_by(YEAR, JURISDICTION_CODE) %>% count() %>%
    setNames(c('YEAR', 'JURISDICTION', 'NUM_INC')) %>%
    ggplot(aes(x = YEAR, y = NUM_INC, group = JURISDICTION, color = JURISDICTION)) +
    geom_line() + geom_point() +
    scale_x_continuous(breaks = scales::pretty_breaks(n = 20)) +
    scale_y_log10(breaks = scales::pretty_breaks(n = 6)) +
    scale_colour_discrete(name = 'Jurisdiction') + 
    theme(legend.position = 'bottom', axis.text.x = element_text(angle = 90)) +
    guides(color = guide_legend(nrow = 1, byrow = TRUE)) +  
    labs(title = 'Number of Shooting Incidents in NYC by Jurisdiction', x= 'Year', y = NULL)
```

* Not surprisingly, most of the shooting incidents in NYC occur at the "Patrol" jurisdiction, meaning, anywhere other than in housings and in  transit.

* Also, interesting to note that the number of shooting incidents in  transit during the COVID-19 lockdown actually decreased, likely as a result of the fact that schools and workplaces were closed during the lockdown period.

### 6.4 - Number of Shooting Incidents in NYC By Time of the Day

* Another interesting question to answer is "which time of the day is more prone to shootings in NYC?". The general perception would suggest that it would likely be late at night but is it really the case?

```{r shootings_year_time_day}
# Incidents by time of the day
df = ny_shootings_unique %>% mutate(YEAR = year(OCCUR_DATE)) %>% 
    group_by(YEAR, OCCUR_TIMEDAY) %>% count() %>%
    setNames(c('YEAR', 'OCCUR_TIMEDAY', 'NUM_INC')) %>%
    ungroup() %>%
    mutate(OCCUR_TIMEDAY = factor(OCCUR_TIMEDAY, levels = c('MORNING', 'AFTERNOON', 'EVENING', 'NIGHT')))

# Line chart - Incidents by time of the day
df %>%
    ggplot(aes(x = YEAR, y = NUM_INC, group = OCCUR_TIMEDAY, 
               color = OCCUR_TIMEDAY)) +
    geom_line() + geom_point() +
    scale_x_continuous(breaks = scales::pretty_breaks(n = 20)) +
    scale_y_log10(breaks = scales::pretty_breaks(n = 10)) +
    scale_colour_discrete(name = 'Time of the Day',
                          labels = c('MORNING (6AM-12PM)', 
                                     'AFTERNOON (12PM-6PM)', 
                                     'EVENING (6PM-12AM)', 
                                     'NIGHT(12AM-6AM)')) + 
    theme(legend.position = 'bottom', axis.text.x = element_text(angle = 90)) +
    guides(color = guide_legend(nrow = 2, byrow = TRUE)) +
    labs(title = 'Number of Shooting Incidents in NYC By Time of the Day', 
         x= 'Year', y = NULL)

# Summarize incidents by time of the day and compute the avg %
df = df %>% group_by(OCCUR_TIMEDAY) %>% 
    summarise(NUM_INC = sum(NUM_INC)) %>%
    mutate(AVG_PCT = round(NUM_INC / sum(NUM_INC) * 100, 1))

# Pie chart - Incidents by time of the day
df %>%
    ggplot(aes(x = '', y = AVG_PCT, fill = OCCUR_TIMEDAY)) +
    geom_bar(width = 1, stat = "identity") +
    coord_polar("y", start = 0) +
    scale_fill_brewer(palette = "Pastel1", 
                      name = 'Time of the Day', 
                      labels = c('MORNING (6AM-12PM)', 
                                 'AFTERNOON (12PM-6PM)', 
                                 'EVENING (6PM-12AM)', 
                                 'NIGHT(12AM-6AM)')) + 
    geom_text(aes(label = paste(AVG_PCT, '%'), x = 1.2), 
              color = "white", size = 4, 
              position = position_stack(vjust = 0.5)) +
    labs(title = 'Number of Shooting Incidents in NYC By Time of the Day', 
         x= NULL, y = NULL) +
    theme_minimal() + 
    theme(
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        panel.border = element_blank(),
        panel.grid = element_blank(),
        axis.ticks = element_blank(),
        axis.text.x = element_blank(),
        legend.position = 'right'
    ) 
```

* As expected, there are significantly more shooting incidents in NYC between the hours of 6PM and 6AM, especially after 12AM.

### 6.5 - Expected Outcome of Shooting Incidents in NYC

* The dataset documentation states that it only includes shooting incidents in which there were victims involved.

* It would be interesting to investigate the typical number of victims and the likelihood of resulting in a murder in order to determine the expected outcome of a shooting incident in NYC

```{r shootings_num_victims}
# Dataframe with number of incidents per number of victims
df = ny_shootings_unique %>% mutate(YEAR = year(OCCUR_DATE)) %>% 
    mutate(NUM_VIC = cut(NUM_VIC, breaks = c(0, 1, 2, max(NUM_VIC)), 
        ordered_result = TRUE, labels = c('1', '2', '> 2'))) %>%
    select(c('YEAR', 'NUM_VIC')) 

# Convert to a table and compute percentages
df = as.data.frame.matrix(
  round(prop.table(table(df$YEAR, df$NUM_VIC), 1) * 100, 2))
df %>% 
  kbl(caption = 'Number of Victims in Shooting Incidents in NYC (%)') %>% 
    kable_styling(bootstrap_options = c("striped", "condensed"), 
                  full_width = FALSE, position = "left", font_size = 12)

# Compute the mean
as.data.frame(round(colMeans(df), 2)) %>% 
  setNames(c('Average (%)')) %>% 
  kbl(caption = 'Average Number of Victims in Shootings Incidents in NYC (%)') %>% 
    kable_styling(bootstrap_options = c("striped", "condensed"), 
                  full_width = FALSE, position = "left", font_size = 12)

# Incidents by number of victims
df = ny_shootings_unique %>% mutate(YEAR = year(OCCUR_DATE)) %>% 
    mutate(NUM_VIC = cut(NUM_VIC, breaks = c(0, 1, 2, max(NUM_VIC)), 
        ordered_result = TRUE, labels = c('1', '2', '3 or more'))) %>%
    group_by(YEAR, NUM_VIC) %>% count() %>%
    setNames(c('YEAR', 'NUM_VIC', 'NUM_INC'))

# Line chart
df %>%
    ggplot(aes(x = YEAR, y = NUM_INC, group = NUM_VIC, color = NUM_VIC)) +
    geom_line() + geom_point() +
    scale_x_continuous(breaks = scales::pretty_breaks(n = 20)) +
    scale_y_log10(breaks = scales::pretty_breaks(n = 10)) +
    scale_colour_discrete(name = 'Number of Victims') + 
    theme(legend.position = 'bottom', axis.text.x = element_text(angle = 90)) +
    labs(title = 'Number of Shooting Incidents in NYC By Number of Victims', x= 'Year', y = NULL)

# Summarize incidents by number of victims and compute the avg %
df = df %>% group_by(NUM_VIC) %>% 
    summarise(NUM_INC = sum(NUM_INC)) %>%
    mutate(AVG_PCT = round(NUM_INC / sum(NUM_INC) * 100, 1))

# Pie chart
df %>%
    ggplot(aes(x = '', y = AVG_PCT, fill = NUM_VIC)) +
    geom_bar(width = 1, stat = "identity") +
    coord_polar("y", start = 0) +
    scale_fill_brewer(palette = "Paired", 
                      name = 'Number of Victims') +
    geom_text(aes(label = paste(AVG_PCT, '%'), x = 1.3), color = "white", size = 4, 
              position = position_stack(vjust = 0.5)) +
    labs(title = 'Number of Shooting Incidents in NYC By Number of Victims', x= NULL, y = NULL) +
    theme_minimal() + 
    theme(
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        panel.border = element_blank(),
        panel.grid = element_blank(),
        axis.ticks = element_blank(),
        axis.text.x = element_blank(),
        legend.position = 'right', 
    ) 

```

```{r shootings_murder_outcome}
# Dataframe with fatality outcome of shooting incidents
df = ny_shootings_unique %>% mutate(YEAR = year(OCCUR_DATE)) %>% 
    select(c('YEAR', 'STATISTICAL_MURDER_FLAG')) 

# Convert to a table and compute percentages
df = as.data.frame.matrix(
  round(prop.table(
    table(df$YEAR, df$STATISTICAL_MURDER_FLAG), 1) * 100, 2))
df %>% 
  kbl(caption = 
        'Fatality Outcome of Shooting Incidents in NYC (%)') %>% 
    kable_styling(bootstrap_options = c("striped", "condensed"), 
                  full_width = FALSE, position = "left", font_size = 12)

# Compute the mean
df = as.data.frame(round(colMeans(df), 2)) %>% 
  setNames(c('Average (%)'))
df %>%
  kbl(caption = 
        'Average Fatality Outcome of Shootings Incidents in NYC (%)') %>% 
    kable_styling(bootstrap_options = c("striped", "condensed"), 
                  full_width = FALSE, position = "left", font_size = 12)

# Reorder columns
df = df %>% setNames(c('AVG_PCT')) %>%
    mutate(MURDER = rownames(df)) 
df = df[, c('MURDER', 'AVG_PCT')]

# Bar chart - fatality outcome of shooting incidents
df %>%
    ggplot(aes(x = MURDER, y = AVG_PCT, fill = MURDER)) +
    geom_bar(stat = "identity", width= 0.8) +
    scale_fill_brewer(palette = "Paired", 
                      name = 'Fatality Outcome') +
    geom_text(aes(label = paste(AVG_PCT, '%')), color = "white", size = 4, 
              vjust = 1.5) +
    labs(title = 'Number of Shooting Incidents in NYC By Fatality Outcome', x= NULL, y = NULL) +
    theme_minimal() + 
    theme(
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        panel.border = element_blank(),
        panel.grid = element_blank(),
        axis.ticks = element_blank(),
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        legend.position = 'right', 
    )
```

* As observed in the data, the majority of shooting incidents that involve victims in NYC, results in only one victim (83.86%) and generally the victim survives the incident (82.72%).

### 6.6 - Typical Profile of the Perpetrator of Shooting Incidents in NYC

* The data also allows to explore the age and sex of a typical perpetrators of shooting incidents in NYC.

```{r shootings_perp_age}
# Dataframe with age group of the perpetrator
df = ny_shootings_unique %>% mutate(YEAR = year(OCCUR_DATE)) %>% 
    select(c('YEAR', 'PERP_AGE_GROUP')) 

# Convert to a table and compute percentages
df = as.data.frame.matrix(
  round(prop.table(table(df$YEAR, df$PERP_AGE_GROUP), 1) * 100, 2))
df %>% 
  kbl(caption = 
        'Age of Perpetrator of Shooting Incidents in NYC (%)') %>% 
    kable_styling(bootstrap_options = c("striped", "condensed"), 
                  full_width = FALSE, position = "left", font_size = 12)

# Compute the mean
df = as.data.frame(round(colMeans(df), 2)) %>% setNames(c('Average (%)'))
df %>%
  kbl(caption = 
        'Average Age of Perpetrator of Shootings Incidents in NYC (%)') %>% 
    kable_styling(bootstrap_options = c("striped", "condensed"), 
                  full_width = FALSE, position = "left", font_size = 12)

# Consolidate 65+ age group with 45+ for cleanliness
df['45-64', ] = df['45-64', ] + df['65+', ]
df['65+', ] = NA
rownames(df)[rownames(df) == '45-64'] = '45+'
df = na.omit(df)

# Reorder columns
df = df %>% setNames(c('AVG_PCT')) %>%
    mutate(PERP_AGE_GROUP = rownames(df)) 
df = df[, c('PERP_AGE_GROUP', 'AVG_PCT')]

# Pie chart - age group of the perpetrator
df %>%
    ggplot(aes(x = '', y = AVG_PCT, fill = PERP_AGE_GROUP)) +
    geom_bar(width = 1, stat = "identity") +
    coord_polar("y", start = 0) +
    scale_fill_brewer(palette = "Blues", 
                      name = 'Perpetrator Age Group') + 
    geom_text(aes(label = paste(AVG_PCT, '%'), x = 1.7), 
              color = "black", size = 4, 
              position = position_stack(vjust = 0.5)) +
    labs(title = 
           'Number of Shooting Incidents in NYC By Age Group of the Perpertrator', x= NULL, y = NULL) +
    theme_minimal() + 
    theme(
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        panel.border = element_blank(),
        panel.grid = element_blank(),
        axis.ticks = element_blank(),
        axis.text.x = element_blank(),
        legend.position = 'right'
    ) 
```

```{r shootings_perp_sex}
# Dataframe with sex of the perpetrator
df = ny_shootings_unique %>% mutate(YEAR = year(OCCUR_DATE)) %>% 
    select(c('YEAR', 'PERP_SEX')) 

# Convert to a table and compute percentages
df = as.data.frame.matrix(
  round(prop.table(table(df$YEAR, df$PERP_SEX), 1) * 100, 2))
df %>% 
  kbl(caption = 
        'Sex of Perpetrator of Shooting Incidents in NYC (%)') %>% 
    kable_styling(bootstrap_options = c("striped", "condensed"), 
                  full_width = FALSE, position = "left", font_size = 12)

# Compute the mean
df = as.data.frame(round(colMeans(df), 1)) %>% 
  setNames(c('Average (%)'))
df %>% 
  kbl(caption = 
        'Sex of Perpetrator of Shootings Incidents in NYC (%)') %>% 
    kable_styling(bootstrap_options = c("striped", "condensed"), 
                  full_width = FALSE, position = "left", font_size = 12)

# Reorder columns
df = df %>% setNames(c('AVG_PCT')) %>%
    mutate(PERP_SEX = rownames(df)) 
df = df[, c('PERP_SEX', 'AVG_PCT')]

# Bar chart
df %>%
    ggplot(aes(x = c('Female', 'Male', 'UNKNOWN'), y = AVG_PCT, fill = PERP_SEX)) +
    geom_bar(stat = "identity", width= 0.9) +
    scale_fill_brewer(palette = "Blues", 
                      name = 'Sex of the Perpetrator') +
    geom_text(aes(label = paste(AVG_PCT, '%')), 
              color = "black", size = 4, 
              vjust = -0.3) +
    labs(title = 
           'Number of Shooting Incidents in NYC By Sex of the Perpertrator', 
         x = NULL, y = NULL) +
    theme_minimal() + 
    theme(
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        panel.border = element_blank(),
        panel.grid = element_blank(),
        axis.ticks = element_blank(),
        axis.text.x = element_text(size = 15, face = 'bold', vjust = 5),
        axis.text.y = element_blank(),
        legend.position = 'none', 
    )
```

* As observed in the data, in the majority of the shooting incidents in NYC the age group of the perpetrator is unknown (53.76%), which suggests that most of the incidents go unresolved, i.e. the perpetrator is not apprehended. 

* Out of known cases, the majority of perpetrators are in the age group of 18 to 44 years old (39.18%) and male (47.42%).

### 6.7 - Typical Profile of the Victims of Shooting Incidents in NYC

* Finally, the data also allows to explore the age and sex of a typical victims of shooting incidents in NYC.

```{r shootings_vic_age}
# Dataframe with age group of the victim
df = ny_shootings_unique %>% mutate(YEAR = year(OCCUR_DATE)) %>% 
    select(c('YEAR', 'VIC_AGE_GROUP')) 

# Convert to a table and compute percentages
df = as.data.frame.matrix(
  round(prop.table(table(df$YEAR, df$VIC_AGE_GROUP), 1) * 100, 2))
df %>% 
  kbl(caption = 'Age of Victims of Shooting Incidents in NYC (%)') %>% 
    kable_styling(bootstrap_options = c("striped", "condensed"), 
                  full_width = FALSE, position = "left", font_size = 12)

# Compute the mean
df = as.data.frame(round(colMeans(df), 2)) %>% 
  setNames(c('Average (%)')) 
df %>% 
  kbl(caption = 'Average Age of Victims of Shootings Incidents in NYC (%)') %>% 
    kable_styling(bootstrap_options = c("striped", "condensed"), 
                  full_width = FALSE, position = "left", font_size = 12)

# Consolidate 65+ age group with 45+
df['45-64', ] = df['45-64', ] + df['65+', ]
df['65+', ] = NA
rownames(df)[rownames(df) == '45-64'] = '45+'
df = na.omit(df)

# Reorder columns
df = df %>% setNames(c('AVG_PCT')) %>%
    mutate(VIC_AGE_GROUP = rownames(df)) 
df = df[, c('VIC_AGE_GROUP', 'AVG_PCT')]

# Pie chart
df %>%
    ggplot(aes(x = '', y = AVG_PCT, fill = VIC_AGE_GROUP)) +
    geom_bar(width = 1, stat = "identity") +
    coord_polar("y", start = 0) +
    scale_fill_brewer(palette = "Greens", 
                      name = 'Victim Age Group') + 
    geom_text(aes(label = paste(AVG_PCT, '%'), x = 1.7), color = "black", size = 3, 
              position = position_stack(vjust = 0.5)) +
    labs(title = 'Number of Shooting Incidents in NYC By Age Group of the Victim', x= NULL, y = NULL) +
    theme_minimal() + 
    theme(
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        panel.border = element_blank(),
        panel.grid = element_blank(),
        axis.ticks = element_blank(),
        axis.text.x = element_blank(),
        legend.position = 'right'
    ) 
```

```{r shootings_vic_sex}
# Dataframe with sex of the victims
df = ny_shootings_unique %>% mutate(YEAR = year(OCCUR_DATE)) %>% 
    select(c('YEAR', 'VIC_SEX')) 

# Convert to a table and compute percentages
df = as.data.frame.matrix(
  round(prop.table(table(df$YEAR, df$VIC_SEX), 1) * 100, 2))
df %>% 
  kbl(caption = 'Age of Victims of Shooting Incidents in NYC (%)') %>% 
    kable_styling(bootstrap_options = c("striped", "condensed"), 
                  full_width = FALSE, position = "left", font_size = 12)

# Compute the mean
as.data.frame(round(colMeans(df), 2)) %>% 
  setNames(c('Average (%)')) %>% 
  kbl(caption = 'Average Age of Victims of Shootings Incidents in NYC (%)') %>% 
    kable_styling(bootstrap_options = c("striped", "condensed"), 
                  full_width = FALSE, position = "left", font_size = 12)
```

* In the vast majority of the shooting incidents in NYC, the victims are in the age group of 18 to 44 years old (83.35%) and male (92.38%).

## 7 - Conclusions

* We can now summarize the conclusions of all the analysis performed.

  1 - The number of shooting incidents in NYC had been decreasing steadily since 2006 until April of 2020, when a significant spike was observed.

  2 - The spike observed in April 2020, coincides with the COVID-19 lockdown situation, which probably suggests that the increase in number of shootings was the result of the higher number of unemployment caused by the economic impact of the lockdown.

  3 - The boroughs of Bronx and Brooklyn are the areas with the highest number of incidents per million inhabitants. These two areas are also the boroughs that experience higher rates of poverty, which suggests a possible correlation between the two data points.

  4 - Most of the shooting incidents in NYC occur anywhere outside housings and transit. During the COVID-19 lockdown, there was an observable decrease in the number of incidents in transit, likely as a result of the fact that schools and workplaces were closed during that period and thus less commuting.

  5 - Consistently with the general perception, most of the shooting incidents happen between the hours of 6PM and 6AM, especially after 12AM.

  6 - Most of the shooting incidents with victims result in only one victim (approx 83%) and generally the victim is expected to survive (approx 82% of the time).

  7 - The perpetrator of shooting incidents in NYC is generally not apprehended since their age and sex is usually unknown (>50%). Out of the known cases, the majority of perpetrators are in the age group of 18 to 44 years old (approx 39%) and male (approx 47%).

  8 - In the vast majority of the shooting incidents in NYC, the victims are in the age group of 18 to 44 years old (approx 83%) and male (approx 92%).

<BR>

## Session info
```{r sessionInfo}
sessionInfo()
```